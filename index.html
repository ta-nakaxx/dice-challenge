<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ゾロ目チャレンジ</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #result { margin-top: 10px; }
    #nameForm { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>🎲 ゾロ目チャレンジ！</h1>
  <p id="stage">読み込み中...</p>
  <button onclick="rollDice()">ダイスを振る</button>
  <p id="result"></p>

  <div id="nameForm" style="display:none;">
    <input type="text" id="playerName" placeholder="あなたの名前">
    <button onclick="submitResult()">記録する</button>
  </div>

  <script>
    const sheetID = "136qSlVsygA4iVBbieZ8etzfJeQOvBawUo3uaCcLX_2I";
    const sheetName = "SuccessLog";
    let diceCount = 2;
    let latestResult = [];
    let resultType = "";

    const successWebhookURL = "https://hook.eu2.make.com/dkxo9a01uaovk75sywloqnkijqtjqfaf";
    const nearMissWebhookURL = "https://hook.eu2.make.com/g6igdb1tv5tmulbjqm8ctg4u17wuxn7u";

    async function fetchStageNumber() {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
      try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        // ★ ここが診断ログ
        console.log("rows内容:", json.table.rows);

        const validRows = json.table.rows.filter(
          row => row.c && row.c[0] && row.c[0].v !== null && row.c[0].v !== ''
        );

        console.log("有効な行数:", validRows.length);
        diceCount = validRows.length + 2;

        document.getElementById("stage").innerText =
          `現在の挑戦段階：${diceCount}個のサイコロで「1のゾロ目」を出せ！`;
      } catch (e) {
        console.error("ステージ読み込み失敗：", e);
        document.getElementById("stage").innerText = "ステージ読み込み失敗";
      }
    }

    function rollDice() {
      document.getElementById("result").innerText = "ダイスを振っています…🎲";
      document.getElementById("nameForm").style.display = "none";

      setTimeout(() => {
        latestResult = [];
        for (let i = 0; i < diceCount; i++) {
          latestResult.push(Math.floor(Math.random() * 6) + 1);
        }

        const allSame = latestResult.every(n => n === latestResult[0]);
        const isOne = latestResult[0] === 1;

        let msg = `出目：${latestResult.join(', ')} → `;
        if (allSame && isOne) {
          msg += "🎉 成功！（1のゾロ目）";
          resultType = "success";
          document.getElementById("nameForm").style.display = "block";
        } else if (allSame) {
          msg += "おしい！ゾロ目だけど1じゃない";
          resultType = "near_miss";
          document.getElementById("nameForm").style.display = "block";
        } else {
          msg += "失敗！";
          resultType = "";
        }

        document.getElementById("result").innerText = ms

