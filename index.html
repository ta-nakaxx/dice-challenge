<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚¾ãƒ­ç›®ãƒãƒ£ãƒ¬ãƒ³ã‚¸</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #result { margin-top: 10px; }
    #nameForm { margin-top: 10px; }
  </style>
</head>
<body>
  <h1>ğŸ² ã‚¾ãƒ­ç›®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ï¼</h1>
  <p id="stage">èª­ã¿è¾¼ã¿ä¸­...</p>
  <button onclick="rollDice()">ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã‚‹</button>
  <p id="result"></p>

  <div id="nameForm" style="display:none;">
    <input type="text" id="playerName" placeholder="ã‚ãªãŸã®åå‰">
    <button onclick="submitResult()">è¨˜éŒ²ã™ã‚‹</button>
  </div>

  <script>
    const sheetID = "136qSlVsygA4iVBbieZ8etzfJeQOvBawUo3uaCcLX_2I";
    const sheetName = "SuccessLog";
    let diceCount = 2;
    let latestResult = [];
    let resultType = "";

    const successWebhookURL = "https://hook.eu2.make.com/dkxo9a01uaovk75sywloqnkijqtjqfaf";
    const nearMissWebhookURL = "https://hook.eu2.make.com/g6igdb1tv5tmulbjqm8ctg4u17wuxn7u";

    async function fetchStageNumber() {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
      try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text.substring(47).slice(0, -2));

        // â˜… ã“ã“ãŒè¨ºæ–­ãƒ­ã‚°
        console.log("rowså†…å®¹:", json.table.rows);

        const validRows = json.table.rows.filter(
          row => row.c && row.c[0] && row.c[0].v !== null && row.c[0].v !== ''
        );

        console.log("æœ‰åŠ¹ãªè¡Œæ•°:", validRows.length);
        diceCount = validRows.length + 2;

        document.getElementById("stage").innerText =
          `ç¾åœ¨ã®æŒ‘æˆ¦æ®µéšï¼š${diceCount}å€‹ã®ã‚µã‚¤ã‚³ãƒ­ã§ã€Œ1ã®ã‚¾ãƒ­ç›®ã€ã‚’å‡ºã›ï¼`;
      } catch (e) {
        console.error("ã‚¹ãƒ†ãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¤±æ•—ï¼š", e);
        document.getElementById("stage").innerText = "ã‚¹ãƒ†ãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¤±æ•—";
      }
    }

    function rollDice() {
      document.getElementById("result").innerText = "ãƒ€ã‚¤ã‚¹ã‚’æŒ¯ã£ã¦ã„ã¾ã™â€¦ğŸ²";
      document.getElementById("nameForm").style.display = "none";

      setTimeout(() => {
        latestResult = [];
        for (let i = 0; i < diceCount; i++) {
          latestResult.push(Math.floor(Math.random() * 6) + 1);
        }

        const allSame = latestResult.every(n => n === latestResult[0]);
        const isOne = latestResult[0] === 1;

        let msg = `å‡ºç›®ï¼š${latestResult.join(', ')} â†’ `;
        if (allSame && isOne) {
          msg += "ğŸ‰ æˆåŠŸï¼ï¼ˆ1ã®ã‚¾ãƒ­ç›®ï¼‰";
          resultType = "success";
          document.getElementById("nameForm").style.display = "block";
        } else if (allSame) {
          msg += "ãŠã—ã„ï¼ã‚¾ãƒ­ç›®ã ã‘ã©1ã˜ã‚ƒãªã„";
          resultType = "near_miss";
          document.getElementById("nameForm").style.display = "block";
        } else {
          msg += "å¤±æ•—ï¼";
          resultType = "";
        }

        document.getElementById("result").innerText = ms

